function ptq(n){var u=n.replace(/;/g,"&").split("&"),i,t,r;for(n={},i=0;i<u.length;i++)r=u[i].split("=",2),t=unescape(r[0]),n[t]||(n[t]=[]),n[t][n[t].length]=r.length>1?unescape(r[1]):!0;return n}function param(){return ptq(location.search.substring(1).replace(/\+/g," "))}function entify(n){return(""+n).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/>/g,"&gt;")}function validateElement(n,t){var i=document.getElementById(n);return i.checkValidity()==!1?($("#"+t).text(" Check the "+i.name+" field. "+i.validationMessage),!0):!1}function diffPasswords(n,t,i){var n=$("#"+n).val(),t=$("#"+t).val();return n==t?($("#"+i).text("Please make sure the old and new passwords are different and try again."),!0):!1}function samePasswords(n,t,i){var n=$("#"+n).val(),t=$("#"+t).val();return n!=t?($("#"+i).text("Please make sure the passwords are the same and try again."),!0):!1}function pauseButton(n,t,i){var r=$("#"+n).val();$("#"+n).attr("value",t+" ("+i/1e3+" secs)");$("#"+n).attr("disabled",!0);setTimeout(function(){$("#"+n).attr("value",r);$("#"+n).attr("disabled",!1)},i)}function pauseOpen(n,t){setTimeout(function(){$("#"+n).dialog("open")},t)}function pauseClose(n,t){setTimeout(function(){$("#"+n).dialog("close")},t)}function timedCount(){var i;try{var r=jwt_decode(user.accesstoken),u=r.exp,n=new Date(0),t=new Date(0);n.setUTCSeconds(u);t.setUTCSeconds((new Date).getTime()/1e3);i=new Date(t.getTime()+6e4);show_console&&console.log("Check if access token is about to expire.");n<i&&(show_console&&console.log("Access token is about to expire, so refresh it."),refreshAccessToken())}catch(f){show_console&&console.log("Access token check error...logging out...");logoutButton()}finally{timer_is_on&&(timer_proxy=setTimeout(timedCount,15e3))}}function startCount(){timer_is_on||(show_console&&console.log("Start authentication timer."),timer_is_on=1,timedCount())}function stopCount(){clearTimeout(timer_proxy);timer_is_on=0;show_console&&console.log("Stop authentication timer.")}function openRegisterDialog(){$("#register-dialog").dialog("isOpen")?$("#register-dialog").dialog("close"):(closeWindows(),$("#register-dialog").dialog("open"))}function openLoginDialog(){$("#login-dialog").dialog("isOpen")?$("#login-dialog").dialog("close"):(closeWindows(),$("#login-dialog").dialog("open"))}function openForgotDialog(){$("#forgot-dialog").dialog("isOpen")?$("#forgot-dialog").dialog("close"):(closeWindows(),$("#forgot-dialog").dialog("open"))}function openResetDialog(){$("#reset-dialog").dialog("isOpen")?$("#reset-dialog").dialog("close"):(closeWindows(),$("#reset-dialog").dialog("open"))}function openIdentityDialog(){$("#identity-dialog").dialog("isOpen")?$("#identity-dialog").dialog("close"):(closeWindows(),$("#identity-message").text(""),$("#identity-dialog").dialog("open"))}function openIdentityDeleteDialog(){$("#identity-delete-dialog").dialog("isOpen")?$("#identity-delete-dialog").dialog("close"):(closeWindows(),$("#identity-delete-dialog").dialog("open"))}function closeWindows(){$("#news-dialog").dialog("close");$("#login-dialog").dialog("close");$("#register-dialog").dialog("close");$("#forgot-dialog").dialog("close");$("#identity-dialog").dialog("close");$("#identity-delete-dialog").dialog("close");$("#reset-dialog").dialog("close");closeWindowsExtension()}function clearMessages(){$("#login-message").text("");$("#register-message").text("");$("#forgot-message").text("");$("#identity-message").text("");$("#identity-delete-message").text("");clearMessagesExtension()}function loginButton(){var n="";(clearMessages(),validateElement("login-email","login-message"))||validateElement("login-password","login-message")||(pauseButton("login-button","Paused",2e3),$.ajax({type:"POST",url:"api/auth/login",timeout:5e3,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({Email:$("#login-email").val(),Password:$("#login-password").val()}),success:function(t){t.success==!1?($("#login-password").val(""),$("#login-message").text(t.message)):(user={email:t.email,firstname:t.firstName,lastname:t.lastName,accesstoken:t.accessToken,refreshtoken:t.refreshToken,refreshtokenexpirytime:t.refreshTokenExpiryTime,role:t.role},n="Welcome "+user.firstname+" "+user.lastname+". You have been logged in!",$("#login-link").hide(),$("#identity-link").show(),$("#logout-link").show(),startCount(),$("#welcome-text-label").text(user.firstname+" "+user.lastname),loginExtention(),$("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time),$("#login-password").val(""),$("#login-dialog").dialog("close"),sendUsage("Login"))},error:function(){console.log("An error occured during login.")}}))}function forgotButton(){var n="";(clearMessages(),validateElement("forgot-email","forgot-message"))||(sendUsage("Forgot Password"),$("#forgot-button").attr("value","Disabled (Close Window)"),$("#forgot-button").attr("disabled",!0),$.ajax({type:"POST",url:"api/auth/forgot",timeout:5e3,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({Email:$("#forgot-email").val()}),success:function(t){n=t.message;t.success?($("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time),$("#forgot-message").text(n),$("#forgot-button").attr("disabled",!0)):($("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time),$("#forgot-message").text(n),$("#forgot-button").attr("value","Submit"),$("#forgot-button").attr("disabled",!1))},error:function(){console.log("An error occured during forgot password.")}}))}function resetButton(){var n="";(clearMessages(),samePasswords("reset-password-new1","reset-password-new2","reset-message"))||validateElement("reset-email","reset-message")||validateElement("reset-password-new1","reset-message")||validateElement("reset-password-new2","reset-message")||(sendUsage("Reset Password"),pauseButton("reset-button","Paused",2e3),$.ajax({type:"POST",url:"api/auth/reset",timeout:5e3,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({Email:$("#reset-email").val(),Password:$("#reset-password-new1").val(),Password2:$("#reset-password-new2").val(),Guid:resetToken}),success:function(t){n=t.message;t.success?($("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time),$("#reset-message").text(n),pauseClose("reset-dialog",2e3),pauseOpen("login-dialog",3e3),resetToken=""):($("#reset-message").text(n),$("#fademessage").css("color","red").html(n).fadeIn(1).fadeOut(fade_message_time))},error:function(){console.log("An error occured during password reset.")}}))}function logoutButton(){sendUsage("Logout");stopCount();clearMessages();closeWindows();$("#login-link").show();$("#identity-link").hide();$("#logout-link").hide();logoutExtention();$("#welcome-text-label").text("");var n="";$.ajax({type:"GET",url:"api/token/revoke",timeout:5e3,headers:{Authorization:"Bearer "+user.accesstoken},success:function(){user=null;n="You have been logged out from the server.";$("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time);show_console&&console.log(n)},error:function(){user=null;console.log("An error occured during logout.")}})}function logoutButtonNoRevoke(){user=null;stopCount();clearMessages();closeWindows();$("#login-link").show();$("#identity-link").hide();$("#logout-link").hide();logoutExtention()}function refreshAccessToken(){$.ajax({type:"POST",url:"api/token/refresh",timeout:5e3,headers:{Authorization:"Bearer "+user.accesstoken},dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({AccessToken:user.accesstoken,RefreshToken:user.refreshtoken}),success:function(n){n.success==!1?(show_console&&console.log(n.message),logoutButton()):(show_console&&console.log("Got a new access token."),user={email:n.email,firstname:n.firstName,lastname:n.lastName,accesstoken:n.accessToken,refreshtoken:n.refreshToken,refreshtokenexpirytime:n.refreshTokenExpiryTime,role:n.role})},error:function(){console.log("An error occured while refreshing token.")}})}function registerButton(){var n="";(clearMessages(),samePasswords("register-password","register-password2","register-message"))||validateElement("register-firstname","register-message")||validateElement("register-lastname","register-message")||validateElement("register-email","register-message")||validateElement("register-password","register-message")||validateElement("register-password2","register-message")||(sendUsage("Register"),$("#register-button").attr("value","Disabled (Close Window)"),$("#register-button").attr("disabled",!0),$.ajax({type:"POST",url:"api/register",timeout:5e3,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({FirstName:$("#register-firstname").val(),LastName:$("#register-lastname").val(),Email:$("#register-email").val(),Password:$("#register-password").val(),Password2:$("#register-password2").val()}),success:function(t){n=t.message;t.success?($("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time),$("#register-message").text(n),$("#login-dialog").dialog("close")):($("#register-message").text(n),$("#fademessage").css("color","red").html(n).fadeIn(1).fadeOut(fade_message_time),$("#register-button").attr("value","Submit"),$("#register-button").attr("disabled",!1))},error:function(){console.log("An error occured during registration.")}}))}function identityUpdateButton(){var n="";if((clearMessages(),!validateElement("identity-firstname","identity-message"))&&!validateElement("identity-lastname","identity-message")){var t=$("#identity-password").val().trim(),i=$("#identity-password-new1").val().trim(),r=$("#identity-password-new2").val().trim();if(t==""&&i==""&&r=="")sendUsage("Identity Update - No Password"),pauseButton("identity-button","Paused",2e3),$.ajax({type:"PUT",url:"api/identity",timeout:5e3,headers:{Authorization:"Bearer "+user.accesstoken},dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({Email:$("#identity-email").text(),FirstName:$("#identity-firstname").val(),LastName:$("#identity-lastname").val(),Password:"",Password2:""}),success:function(t){t&&(user.firstname=t.firstName,user.lastname=t.lastName,n="Profile modified "+t.firstName+".",$("#welcome-text-label").text(user.firstname+" "+user.lastname),$("#identity-message").text(n),$("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time),pauseClose("identity-dialog",2e3))},error:function(){console.log("An error occured during identity update without password.")}});else{if(validateElement("identity-password","identity-message"))return;if(validateElement("identity-password-new1","identity-message"))return;if(validateElement("identity-password-new2","identity-message"))return;if(samePasswords("identity-password-new1","identity-password-new2","identity-message"))return;if(diffPasswords("identity-password","identity-password-new2","identity-message"))return;sendUsage("Identity Update - Yes Password");pauseButton("identity-button","Paused",2e3);$.ajax({type:"PUT",url:"api/identity",timeout:5e3,headers:{Authorization:"Bearer "+user.accesstoken},dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify({Email:$("#identity-email").text(),FirstName:$("#identity-firstname").val(),LastName:$("#identity-lastname").val(),Password:$("#identity-password").val(),Password2:$("#identity-password-new2").val()}),success:function(t){t?(n="Profile modified "+t.firstName+". Please login again.",$("#identity-message").text(n),setTimeout(function(){logoutButton();$("#login-dialog").dialog("open")},2e3)):$("#identity-message").text(t.message)},error:function(){console.log("An error occured during identity update with password.")}})}}}function identityDeleteProfileButton(){var t=confirm('This will delete your user profile. Your settings and diagrams will be left in local storage. Press "Ok" to coninue or "Cancel" to abort.',"Delete Local Storage"),n;sendUsage("Identity Delete Profile");t&&(pauseButton("identity-delete-profile","Paused",2e3),n="",$.ajax({type:"DELETE",url:"api/identity",timeout:5e3,headers:{Authorization:"Bearer "+user.accesstoken},dataType:"json",contentType:"application/json",processData:!1,success:function(t){logoutButtonNoRevoke();t&&(n="Your profile has been deleted "+t.firstName+".",$("#fademessage").css("color","black").html(n).fadeIn(1).fadeOut(fade_message_time),$("#identity-delete-dialog").dialog("close"))},error:function(){console.log("An error occured while deleting server profile.")}}))}function identityDeleteLocalStorageButton(){var n=confirm('This will delete all local data! Press "Ok" to coninue or "Cancel" to abort.',"Delete Local Storage"),t;sendUsage("Identity Delete Local");n&&(pauseButton("identity-delete-local","Paused",1e3),t="",clearMessages(),localStorage.clear(),window.location.reload(!0))}function openIdentityDeleteLocalStorageButton(){$("#identity-delete-local-dialog").dialog("isOpen")?$("#identity-delete-local-dialog").dialog("close"):$("#identity-delete-local-dialog").dialog("open")}function toggleNewspop(n){sendUsage("Toggle News Popup");typeof Storage!="undefined"&&(document.getElementById("newpopstop").checked?localStorage.setItem(n,news_version):localStorage.setItem(n,"-1"))}function openNewsDialogButton(n){$("#news-dialog").dialog("isOpen")?$("#news-dialog").dialog("close"):(closeWindows(),sendUsage("Open News Dialog"),openNewsDialog(n))}function openNewsDialog(n){$("#login-dialog").dialog("isOpen")||$("#reset-dialog").dialog("isOpen")||$("#register-dialog").dialog("isOpen")||$.ajax({type:"GET",url:"api/news/"+news_version,timeout:5e3,success:function(t){$("#newsitem").html(t.content);document.getElementById("newpopstop").checked=localStorage.getItem(n)==news_version?!0:!1;$("#news-dialog").dialog("open");$("#news-dialog").scrollTop("0")},error:function(){console.log("An error occured while opening news dialog.")}})}function sendUsage(n){if(show_console&&console.log("SendUsage: "+n),send_usage_info){var t=user==null?"":user.accesstoken;$.ajax({type:"GET","async":!0,url:"api/usage/"+n,headers:{Authorization:"Bearer "+t},timeout:5e3,success:function(n){show_console&&console.log("SendUsage: "+n.message)},error:function(){console.log("An error occured while loading a single sample.")}})}}function onDocumentLoadCommon(){$("#identity-link").hide();$("#logout-link").hide()}var user=null,timer_proxy,timer_is_on=0,resetToken="";